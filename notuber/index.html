<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>The Black Car Service</title>
<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>
  <div id="map"></div>
  <script>
    /* round function source: http://www.jacklmoore.com/notes/rounding-in-javascript */
    function round(value, decimals) {
      return Number(Math.round(value+'e'+decimals)+'e-'+decimals);
    }
    function initMap() {
      var usa = new google.maps.LatLng(37.0902, -95.7129);
      var map = new google.maps.Map(document.getElementById('map'), {
        center: usa,
        zoom: 4
      });
      
      var icons = {
        passenger: {
          url: "passenger.png",
          scaledSize: new google.maps.Size(50, 50),
          origin: new google.maps.Point(0, 0),
          anchor: new google.maps.Point(25, 50)
        },
        driver: {
          url: "black_car.png",
          scaledSize: new google.maps.Size(50, 20),
          origin: new google.maps.Point(0, 0),
          anchor: new google.maps.Point(25, 20) 
        }
      };
      
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
          var selfPos = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
          
          var infowindow = new google.maps.InfoWindow();

          function addMarker(user) {
            var marker = new google.maps.Marker({
              position: user.position,
              icon: icons[user.type],
              map: map
            });
            var distance = round(google.maps.geometry.spherical.computeDistanceBetween(marker.position, selfPos) * 0.000621371, 2);
            if (distance == 0) {
              marker.addListener('click', function() {
                infowindow.setContent('<div id="infowindow"><p><b>Username: </b>'+user.name+ '</p>');
                infowindow.open(map, marker);
              });
            } else {
              marker.addListener('click', function() {
                infowindow.setContent('<div id="infowindow"><p><b>Username: </b>'+user.name+ '</p><p><b>Distance: </b>'+distance+' mi</p>');
                infowindow.open(map, marker);
              });
            }
          }

          var users = [
            {
              name: 'bG3XpClP',
              position: selfPos,
              type: 'passenger'
            }, {
              name: 'Elizabeth',
              position: new google.maps.LatLng(42.4075, -71.1190),
              type: 'driver'
            }
          ];

          for (var i = 0, user; user = users[i]; i++) {
            addMarker(user);
          }

          map.setCenter(selfPos);
          map.setZoom(15);
        }, function () {
          alert('Error: Geolocation failed.');
        });
      } else {
          alert('Error: Your browser does not support geolocation.');
      }
    }
  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDINqE4Zh55gFfI0eyzhIQYKNVRWyWYwm4&libraries=geometry&callback=initMap" async defer></script>
</body>
</html>	